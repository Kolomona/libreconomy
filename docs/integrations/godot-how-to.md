# Integrating `libreconomy` into a Godot Project (Godot 4 GDExtension Focus)

This guide shows how to consume the Rust `libreconomy` simulation library inside a Godot game (Godot 4 recommended). It uses a thin C++ GDExtension bridge that forwards calls into the exported Rust C ABI produced by `cbindgen` + Uniffi.

> If you're still on Godot 3, see the legacy GDNative appendix at the end. Prefer upgrading—GDExtension removes the recompilation friction present in GDNative.

## 1. Overview
`libreconomy` is compiled as a native shared library (`liblibreconomy.so` on Linux) with accompanying headers and optional language bindings. For Godot integration you only need:

- The shared library (`liblibreconomy.so` or platform equivalent)
- The C header (`libreconomy.h`) generated via `cbindgen`
- (Optional) Uniffi-generated language bindings if you embed scripting languages other than GDScript (not needed for core integration)

Rather than calling the Rust library directly from GDScript, we create a small C++ GDExtension that wraps exported functions and exposes a high-level `LibreEconomy` class to Godot.

## 2. One-command bundle: `dist/godot4/`
Run the release script to build Rust, docs, and a Godot 4 integration bundle.

```bash
bash scripts/release.sh
```

After it finishes, check `dist/godot4/`:

- `lib/` — Rust shared library (`liblibreconomy.*`) and header (`libreconomy.h`)
- `bridge/` — C++ GDExtension sources: `libreconomy_bridge.cpp`, `libreconomy.gdextension`, `SConstruct`
- `build/` — output location where the bridge (.so) will be produced if you build it
- `README.md` — quick steps to build and drop into your Godot project

If you set `GODOT_CPP_DIR` and have SCons installed, the script can optionally auto-build the bridge. Otherwise, you can build it yourself using the scaffold in `bridge/`.

## 3. Godot Project Layout (Suggested)
```
my_godot_game/
  addons/ (if needed)
  native/
    libreconomy/
      liblibreconomy.so          # Rust shared library
      libreconomy.h              # C header
    libreeconomy_gdextension.so# Built bridge from dist/godot4/build/
    liblibreconomy.so          # From dist/godot4/lib/
    libreconomy.h              # From dist/godot4/lib/
    libreconomy.gdextension    # From dist/godot4/bridge/
  scripts/
    test_libreconomy.gd
  project.godot
```

## 4. Prereq: godot-cpp for Godot 4.5.1 (Linux x86_64)
Build or fetch `godot-cpp` matching Godot v4.5.1. Set an environment variable pointing to it:

```bash
export GODOT_CPP_DIR=/path/to/godot-cpp-4.5.1-linux-x86_64
```

It must contain `include/` and `bin/` with the compiled `libgodot-cpp`.

## 5. C++ Bridge Implementation
Create `libreconomy_bridge.cpp`:

```cpp
// libreconomy_bridge.cpp
#include <godot_cpp/classes/ref_counted.hpp>
#include <godot_cpp/core/class_db.hpp>
#include <godot_cpp/gdextension_interface.h>
#include "libreconomy.h" // Generated by cbindgen

using namespace godot;

class LibreEconomy : public RefCounted {
    GDCLASS(LibreEconomy, RefCounted);
protected:
    static void _bind_methods() {
        ClassDB::bind_method(D_METHOD("version"), &LibreEconomy::version);
        ClassDB::bind_method(D_METHOD("agent_count"), &LibreEconomy::agent_count);
        // Future: add bind_method calls for create_agent, remove_agent, query components, etc.
    }
public:
    String version() const {
        const char *v = libreconomy_version(); // Example exported Rust fn; ensure it's in header
        return String(v);
    }
    int64_t agent_count() const {
        return (int64_t)get_agent_count(); // Replace with actual exported count function
    }
};

extern "C" GD_EXTENSION_API GDExtensionBool
libreconomy_library_init(const GDExtensionInterface *p_interface,
                         GDExtensionClassLibraryPtr p_library,
                         GDExtensionInitialization *r_initialization) {
    GDExtensionBinding::InitObject init_obj(p_interface, p_library, r_initialization);
    init_obj.register_initializer([]() { ClassDB::register_class<LibreEconomy>(); });
    init_obj.set_minimum_library_initialization_level(MODULE_INITIALIZATION_LEVEL_SCENE);
    return init_obj.init();
}
```

Adjust function names (`libreconomy_version`, `get_agent_count`) to actual exported symbols. Consult `libreconomy.h` to confirm.

## 6. GDExtension Configuration File
Create `libreconomy.gdextension`:

```ini
[configuration]
entry_symbol = "libreconomy_library_init"
compatibility_minimum = 4.0

[libraries]
linux.debug.x86_64 = "res://native/libreconomy/libreconomy_gdextension.so"
linux.release.x86_64 = "res://native/libreconomy/libreconomy_gdextension.so"
# Add macOS / Windows variants after building:
# macos.release.arm64 = "res://native/libreconomy/libreconomy_gdextension.dylib"
# windows.release.x86_64 = "res://native/libreconomy/libreconomy_gdextension.dll"
```

## 7. Build the bridge (SCons)
From `dist/godot4/`, build the bridge using SCons and the scaffold:

```python
# In shell:
# 1) export GODOT_CPP_DIR=/path/to/godot-cpp-4.5.1-linux-x86_64
# 2) scons -C dist/godot4/bridge
# Output: dist/godot4/build/libreconomy_gdextension.so
```

Platform adjustments:
- Windows: produce `.dll` and ensure `liblibreconomy.dll` is discoverable (same folder or PATH).
- macOS: produce `.dylib`; may need `install_name_tool` changes for runtime path.

## 8. Runtime Library Placement
Copy these into your project under `res://native/libreconomy/`:
- `dist/godot4/build/libreconomy_gdextension.so` (the bridge)
- `dist/godot4/lib/liblibreconomy.so` (Rust library)
- `dist/godot4/bridge/libreconomy.gdextension` (config)

## 9. Using the Extension from GDScript
Example script `scripts/test_libreconomy.gd`:

```gdscript
extends Node

func _ready():
    var sim = LibreEconomy.new()
    print("LibreEconomy version: %s" % sim.version())
    print("Agents: %d" % sim.agent_count())
```

Attach to a scene, run, and inspect the output. Extend the bridge with more methods as needed.

## 10. Exposing More Functionality
When extending:
1. Ensure the Rust function is `pub extern "C"` (or exported via Uniffi if you re-route) and present in `libreconomy.h`.
2. Add a corresponding C++ method in `LibreEconomy` that marshals types (e.g., arrays → PackedInt32Array, strings → `String`).
3. Bind with `ClassDB::bind_method`.
4. Rebuild the extension.

For collections/components, consider creating additional wrapper classes (e.g., `AgentHandle`, `InventoryView`) to keep the API clean.

## 11. Hot Reload & Rebuild Loop
- Change Rust code → `bash scripts/release.sh` (rebuilds lib and updates dist/godot4)
- Re-run `scons -C dist/godot4/bridge` if headers or ABI changed
- Restart Godot editor if symbols don’t refresh

## 12. Versioning & Stability
Track a Rust-side semantic version and expose it via a function like `libreconomy_version()`. Increment when the C ABI changes. Godot scripts can assert compatibility.

## 13. Platform Notes
| Platform | Notes |
|----------|-------|
| Linux | Keep both .so files in same directory. RPATH generally okay inside Godot. |
| Windows | Ensure `liblibreconomy.dll` is next to `libreconomy_gdextension.dll`; name may need `lib` prefix removal depending on build tools. |
| macOS | Use `.dylib`; may need `install_name_tool -id @rpath/libreconomy.dylib` for relocation. |

## 14. Performance Considerations
- Batch operations: Prefer exposing Rust functions that operate on multiple agents/components at once vs. looping in GDScript.
- Avoid excessive string conversions—use numeric IDs or handles.
- If simulation ticks are heavy, expose a `step_simulation(delta_ms)` function in Rust.

## 15. Debugging Tips
- If Godot fails to load the extension, check the editor log for missing symbols.
- Use `ldd libreconomy_gdextension.so` (Linux) to verify `liblibreconomy.so` resolution.
- If version mismatch, rebuild godot-cpp for your exact engine version.

## 16. Optional: Uniffi Bindings Inside Godot
If embedding Python, Kotlin, or Swift (e.g., via custom modules), you can also use the Uniffi-generated bindings in `dist/`. This is atypical for standard GDScript workflows and generally unnecessary.

## 17. Legacy Godot 3 (GDNative) Appendix (Brief)
1. Produce `liblibreconomy.so` & header.
2. Write a C wrapper exposing Godot 3 style entry points (`godot_gdnative_init`, etc.).
3. Create `.gdnlib` referencing the library.
4. Bind methods similarly via `godot_method_bind`. (Higher maintenance — upgrade recommended.)

## 18. Next Steps / Enhancements
- Add automated build pipeline that runs `scripts/release.sh` and then rebuilds the GDExtension.
- Implement richer API: agent creation/removal, component queries, simulation stepping.
- Add integration tests using headless Godot (`--headless --quit` scripts) calling the extension.

## 19. Checklist
- [ ] Rust artifacts built (`dist/liblibreconomy.so`, `dist/libreconomy.h`)
- [ ] C++ bridge compiles
- [ ] `.gdextension` file points to built bridge
- [ ] Shared libraries placed in `res://native/libreconomy/`
- [ ] Basic GDScript call returns version & agent count
- [ ] Extended methods (optional) implemented & documented

---
**Maintenance Reminder:** Re-run `scripts/release.sh` whenever public Rust API changes, then rebuild the GDExtension to keep headers and symbols in sync.
